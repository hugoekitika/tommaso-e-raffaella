<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lancia il Bouquet 2D</title>
  <style>
    body {
      margin: 0;
      background-color: #fff7f0;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #d0f0c0;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const GRAVITY = 0.5;
    const MAX_POWER = 15;

    let sposaImg = new Image();
    let bouquetImg = new Image();
    let testimoneImg = new Image();
    sposaImg.src = "img/sposa_bouquet.png";
    bouquetImg.src = "img/bouquet.png";
    testimoneImg.src = "img/testimone.png";

    const sposa = { x: 80, y: canvas.height - 150 };
    let bouquet = null;
    let charging = false;
    let chargePower = 0;
    let launchAngle = Math.PI / 4;
    let score = 0;
    let shotsLeft = 5;

    const targets = [];
    const NUM_TARGETS = 3;

    function resetTargets() {
      targets.length = 0;
      for (let i = 0; i < NUM_TARGETS; i++) {
        targets.push({
          x: 500 + i * 100 + Math.random() * 100,
          y: canvas.height - 100 - Math.random() * 100,
          hit: false
        });
      }
    }

    function drawTrajectory(x, y, angle, power) {
      ctx.beginPath();
      ctx.strokeStyle = "rgba(0,0,0,0.4)";
      for (let t = 0; t < 30; t++) {
        let dx = power * Math.cos(angle) * t * 0.5;
        let dy = power * Math.sin(angle) * t * 0.5 - 0.5 * GRAVITY * (t * 0.5) * (t * 0.5);
        if (t === 0) ctx.moveTo(x + dx, y - dy);
        else ctx.lineTo(x + dx, y - dy);
      }
      ctx.stroke();
    }

    function launchBouquet() {
      bouquet = {
        x: sposa.x + 40,
        y: sposa.y - 20,
        vx: chargePower * Math.cos(launchAngle),
        vy: -chargePower * Math.sin(launchAngle)
      };
      chargePower = 0;
      charging = false;
      shotsLeft--;
    }

    function update() {
      if (bouquet) {
        bouquet.vy += GRAVITY;
        bouquet.x += bouquet.vx;
        bouquet.y += bouquet.vy;

        for (let target of targets) {
          if (!target.hit && bouquet.x > target.x && bouquet.x < target.x + 50 && bouquet.y > target.y && bouquet.y < target.y + 50) {
            target.hit = true;
            score++;
          }
        }

        if (bouquet.y > canvas.height || bouquet.x > canvas.width) {
          bouquet = null;
          if (shotsLeft <= 0) {
            if (targets.every(t => t.hit)) {
              resetTargets();
              shotsLeft = 5;
            } else {
              alert("Hai finito i colpi! Punteggio: " + score);
              score = 0;
              shotsLeft = 5;
              resetTargets();
            }
          }
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(sposaImg, sposa.x, sposa.y, 100, 150);

      if (bouquet) {
        ctx.drawImage(bouquetImg, bouquet.x, bouquet.y, 30, 30);
      }

      for (let t of targets) {
        if (!t.hit) ctx.drawImage(testimoneImg, t.x, t.y, 50, 50);
      }

      if (charging) {
        drawTrajectory(sposa.x + 40, sposa.y - 20, launchAngle, chargePower);
      }

      ctx.fillStyle = "#b85c38";
      ctx.font = "18px sans-serif";
      ctx.fillText("Punteggio: " + score, 10, 20);
      ctx.fillText("Tiri rimasti: " + shotsLeft, 10, 40);
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    canvas.addEventListener("mousedown", () => {
      if (!bouquet && shotsLeft > 0) {
        charging = true;
        chargePower = 0;
      }
    });

    canvas.addEventListener("mouseup", () => {
      if (charging) {
        launchBouquet();
      }
    });

    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const dx = mouseX - (sposa.x + 40);
      const dy = (sposa.y - 20) - mouseY;
      launchAngle = Math.atan2(dy, dx);
    });

    function chargeLoop() {
      if (charging && chargePower < MAX_POWER) {
        chargePower += 0.2;
      }
      setTimeout(chargeLoop, 16);
    }

    resetTargets();
    chargeLoop();
    gameLoop();
  </script>
</body>
</html>

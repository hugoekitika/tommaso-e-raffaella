<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üç∞ Difendi la Torta</title>

<style>
html,body{
  margin:0;
  overflow:hidden;
  background:#fff7ec;
  font-family:system-ui;
}
#ui{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  font-weight:700;
  color:#a66;
}
#msg{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  color:#844;
}
canvas{
  display:block;
  margin:auto;
}
</style>
</head>

<body>

<div id="ui">Ospiti fermati: 0</div>
<div id="msg">Tocca per iniziare</div>
<canvas id="game"></canvas>

<script>
(() => {
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");
const msg = document.getElementById("msg");

function resize(){
  canvas.width = Math.min(innerWidth, 420);
  canvas.height = 500;
}
resize();
addEventListener("resize", resize);

// --- IMMAGINI ---
const cakeImg = new Image();
cakeImg.src = "img/torta_affam.png";

const guestImg = new Image();
guestImg.src = "img/osp_affam.png";

// --- STATO ---
let running = false;
let gameOver = false;
let score = 0;

// --- TORTA ---
const cake = {
  x: 0,
  y: 0,
  size: 70
};

function resetCake(){
  cake.x = canvas.width / 2 - cake.size / 2;
  cake.y = canvas.height / 2 - cake.size / 2;
}
resetCake();

// --- OSPITI ---
let guests = [];
let spawnTimer = 0;
let spawnInterval = 120; // frame iniziali

function spawnGuest(){
  const angle = Math.random() * Math.PI * 2;
  const dist = 300;
  guests.push({
    x: cake.x + cake.size/2 + Math.cos(angle) * dist,
    y: cake.y + cake.size/2 + Math.sin(angle) * dist,
    size: 45,
    speed: 1.2 + score * 0.03
  });
}

// --- UPDATE ---
function update(){
  if(!running) return;

  spawnTimer++;
  if(spawnTimer >= spawnInterval){
    spawnTimer = 0;
    spawnGuest();
    spawnInterval = Math.max(25, spawnInterval * 0.97); // sempre pi√π veloce
  }

  guests.forEach(g => {
    const dx = (cake.x + cake.size/2) - (g.x + g.size/2);
    const dy = (cake.y + cake.size/2) - (g.y + g.size/2);
    const d = Math.hypot(dx, dy);

    g.x += dx / d * g.speed;
    g.y += dy / d * g.speed;

    if(d < cake.size/2){
      running = false;
      gameOver = true;
      msg.textContent = "üç∞ Torta divorata! Tocca per riprovare";
    }
  });

  ui.textContent = "Ospiti fermati: " + score;
}

// --- DRAW ---
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // torta
  ctx.drawImage(cakeImg, cake.x, cake.y, cake.size, cake.size);

  // ospiti
  guests.forEach(g => {
    ctx.drawImage(guestImg, g.x, g.y, g.size, g.size);
  });
}

// --- LOOP ---
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

// --- INPUT ---
canvas.addEventListener("mousedown", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if(!running){
    if(gameOver){
      guests = [];
      score = 0;
      spawnInterval = 120;
      gameOver = false;
    }
    running = true;
    msg.textContent = "";
    return;
  }

  guests = guests.filter(g => {
    if(
      x > g.x && x < g.x + g.size &&
      y > g.y && y < g.y + g.size
    ){
      score++;
      return false;
    }
    return true;
  });
});

})();
</script>

</body>
</html>
